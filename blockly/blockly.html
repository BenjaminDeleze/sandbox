<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Streaming viewer</title>
    <link rel="icon" type="image/png" href="webots_icon.png">
    <script src="https://unpkg.com/blockly"></script>
    <style>
      html, body {
        padding:0;
        margin:0;
        height: 100%;
      }

      webots-view {
        position: absolute!important;
        right: 0px;
        width: calc(100% - 550px);
        border: 0px;
        margin: 0px;
        top: 0px;
      }
    </style>
  </head>

  <body>
    <div id=webotsPlaceholder></div>
    <div id="blocklyDiv" style="height: 480px; width: 400px;"></div>
    <button id=button>Generate Code</button>

    <script type="module">
      import WebotsView from "https://cyberbotics.com/wwi/R2022b/WebotsView.js";

      let webotsView = new WebotsView();
      webotsView.showQuit = false;
      document.body.appendChild(webotsView);
      webotsView.connect('ws://localhost:1234');

      Blockly.defineBlocksWithJsonArray([
        {
          "type": "nao_action",
          "message0": "Nao %1",
          "args0": [
            {
              "type": "field_dropdown",
              "name": "VALUE",
              "options": [
                ["Forward", "forward"],
                ["Backward", "backward"],
              ]
            }
          ],
          "previousStatement": null,
          "nextStatement": null,
          "colour": 355
        }
      ]);

      Blockly.inject('blocklyDiv', {
        toolbox: document.getElementById('toolbox'),
        scrollbars: false
        });

      Blockly.JavaScript['nao_action'] = function(block) {
        let value = '\'' + block.getFieldValue('VALUE') + '\'';
        return "console.log('test ' +" + value + ");sendCommand();"
      };

      let button = document.getElementById('button');
      button.onclick = () => {
        let code = Blockly.JavaScript.workspaceToCode(Blockly.getMainWorkspace());
        console.log(code)
        try {
          eval(code);
        } catch (error) {
          console.log(error)
        }
      }

      function sendCommand() {
        console.log("send")
        let message = {
          name: "supervisor",
          message: "upload:" + "salut"
        };
        webotsView.sendMessage('robot:' + JSON.stringify(message));
      }
    </script>
  </body>
</html>

<xml id="toolbox" style="display: none">
  <block type="controls_repeat_ext">
    <value name="TIMES">
      <shadow type="math_number">
        <field name="NUM">5</field>
      </shadow>
    </value>
  </block>
  <block type="nao_action"></block>
</xml>
